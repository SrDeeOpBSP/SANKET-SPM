<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPM Stop Analysis Dashboard (Excel Filter)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script> 
  <style>
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        margin: 0;
        padding: 30px; /* Original padding */
        min-height: 100vh; /* 'height' se 'min-height' kiya */
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
    }

    h1 {
        text-align: center;
        color: #1e3a8a;
        font-size: 2.5rem;
        margin-bottom: 30px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start; /* Taki filter alag-alag height le sakein */
        gap: 25px;
        margin-bottom: 30px;
        padding: 25px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        width: 100%;
        box-sizing: border-box;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .controls:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* --- Excel Filter Styling --- */
    .filter-group-excel {
        display: flex;
        flex-direction: column;
        min-width: 250px;
        flex: 1; /* Taki space le sake */
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-group-excel label {
        font-weight: 700;
        margin-bottom: 10px;
        color: #1f2937;
        font-size: 1.1rem;
    }

    .filter-search {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 0.95rem;
        background: #fff;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .filter-search:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* --- Checkbox List (Scrollable) --- */
    .checkbox-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        max-height: 180px;  /* YEH LINE BOX KO CHOTA KARTI HAI */
        overflow-y: auto;   /* YEH LINE SCROLLBAR LAATI HAI */
        background: #ffffff;
        scrollbar-width: thin;
        scrollbar-color: #93c5fd #e5e7eb;
    }

    .checkbox-list::-webkit-scrollbar {
        width: 6px;
    }

    .checkbox-list::-webkit-scrollbar-track {
        background: #e5e7eb;
        border-radius: 3px;
    }

    .checkbox-list::-webkit-scrollbar-thumb {
        background: #93c5fd;
        border-radius: 3px;
    }

    .checkbox-list div {
        display: flex;
        align-items: center;
    }

    .checkbox-list label {
        display: flex;
        align-items: center;
        font-weight: 500;
        margin-bottom: 0;
        width: 100%;
        color: #374151;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .checkbox-list label:hover { color: #1e40af; }
    .checkbox-list input { margin-right: 10px; accent-color: #3b82f6; }

    /* --- Rake Filter Styling --- */
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
        flex: 1; /* Taki space le sake */
    }

    .filter-group label {
        font-weight: 700;
        margin-bottom: 10px;
        color: #1f2937;
        font-size: 1.1rem;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 15px;
        border-radius: 6px;
        background: #f9fafb; /* Consistent background */
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); /* Consistent shadow */
    }

    .checkbox-group div { display: flex; align-items: center; }
    .checkbox-group input { margin-right: 10px; accent-color: #3b82f6; }
    .checkbox-group label {
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: color 0.3s ease;
        margin-bottom: 0; /* Override */
    }
    .checkbox-group label:hover { color: #1e40af; }

    /* --- Recent Filter Select --- */
    .filter-group #recent-filter {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        background: #fff;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        background: #f9fafb; /* Consistent background */
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); /* Consistent shadow */
    }

    .filter-group #recent-filter:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    /* --- Chart Container --- */
    #chart-container {
        width: 100%;
        max-width: 1200px;
        height: 650px; /* Original height */
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        padding: 25px;
        box-sizing: border-box;
        display: none;
        transition: transform 0.3s ease;
    }

    #chart-container:hover {
        transform: translateY(-5px);
    }

    #loading {
        text-align: center;
        font-size: 1.3em;
        color: #6b7280;
        padding: 30px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* --- Buttons --- */
    #generate-btn, #toggle-average-btn {
        background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        margin-left: 10px;
        transition: background 0.3s ease, transform 0.2s ease;
        align-self: center; /* Vertically align with other groups */
        margin-top: 25px; /* Original margin */
    }

    #generate-btn:hover, #toggle-average-btn:hover {
        background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
        transform: scale(1.05);
    }

    /* This style was in your original code, but #recent-filter is now inside .filter-group */
    /* I've kept the new styling from above and commented this out to avoid conflict */
    /*
    #recent-filter {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        background: #fff;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #recent-filter:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    */
</style>
</head>
<body>

    <h1>SPM Stop Analysis Dashboard</h1>
    <div id="loading">Loading data from Google Sheet...</div>

    <div class="controls" id="filters-panel" style="display: none;">
        
        <div class="filter-group-excel">
            <label for="lp-search">Select LP ID (Multiple):</label>
            <input type="text" id="lp-search" class="filter-search" onkeyup="filterCheckboxes('lp-search', 'lp-filter-list')" placeholder="Search LP...">
            <div id="lp-filter-list" class="checkbox-list">
            </div>
        </div>
        
        <div class="filter-group-excel">
            <label for="location-search">Select Stop Location (Multiple):</label>
            <input type="text" id="location-search" class="filter-search" onkeyup="filterCheckboxes('location-search', 'location-filter-list')" placeholder="Search Location...">
            <div id="location-filter-list" class="checkbox-list">
            </div>
        </div>

        <div class="filter-group">
            <label>Select Rake Type (Multiple):</label>
            <div class="checkbox-group" id="rake-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div><input type="checkbox" id="rake-all" value="ALL" checked><label for="rake-all">ALL</label></div>
                <div><input type="checkbox" id="rake-goods-loaded" value="GOODS LOADED" checked><label for="rake-goods-loaded">GOODS LOADED</label></div>
                <div><input type="checkbox" id="rake-goods-empty" value="GOODS EMPTY" checked><label for="rake-goods-empty">GOODS EMPTY</label></div>
                <div><input type="checkbox" id="rake-coaching" value="COACHING" checked><label for="rake-coaching">COACHING</label></div>
                <div><input type="checkbox" id="rake-memu" value="MEMU" checked><label for="rake-memu">MEMU</label></div>
            </div>
        </div>

        <div class="filter-group">
            <label>Select Number of Recent Analyses:</label>
            <select id="recent-filter">
                <option value="all" selected>All</option>
                <option value="10">Last 10</option>
                <option value="20">Last 20</option>
                <option value="50">Last 50</option>
            </select>
        </div>
        
        <button id="generate-btn">Generate Graph</button>
        <button id="toggle-average-btn">Show Only Average Profile</button>
    </div>

    <div id="chart-container"></div>

    <script>
        // --- APNI DETAILS YAHAN DAALEIN ---
        const API_KEY = 'AIzaSyAw23pJz0K9fZb2rRRAe2C2cJDilRc0Kac'; 
        const SHEET_ID = '1qYmIAKzt4rAVP0BPTTipzdOgIrwus6P-oGNf5HVekJM';
        const RANGE = 'Sheet1!A:AX'; // उदा: 'Sheet1!A:AX'
        // ----------------------------------------

        // --- SAHI COLUMN INDEX MAPPING (A=0, B=1...) ---
        const COLS = {
            LP_ID: 5,         // Column F
            STOP_LOCATION: 23, // Column X
            KM: 26,           // Column AA
            SPEED_800: 28,    // Column AC
            SPEED_500: 29,    // Column AD
            SPEED_100: 30,    // Column AE
            SPEED_50: 31,     // Column AF
            RAKE_TYPE: 49     // Column AX
        };

        const LINE_LIMIT = 50; 

        let myChart;
        let processedData = []; 
        let lpSet = new Set();
        let locationSet = new Set();
        const loadingDiv = document.getElementById('loading');
        const chartDiv = document.getElementById('chart-container');
        const filtersPanel = document.getElementById('filters-panel');
        let chartBaseOption; // Global variable Chart ki base settings ke liye
        let showOnlyAverage = false; // Track whether to show only average profile

        // --- 1. JAB PAGE LOAD HOGA ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            loadAndProcessData(); 
            document.getElementById('generate-btn').addEventListener('click', updateChart);
            document.getElementById('toggle-average-btn').addEventListener('click', toggleAverageProfile);
        });

        // --- 2. CHART KO INITIALIZE KARNA (Updated) ---
        function initChart() {
            myChart = echarts.init(chartDiv);
            
            // Base settings ko global variable (chartBaseOption) mein store karo
            chartBaseOption = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }, 
                    formatter: (params) => {
                        let tooltip = `Distance: ${params[0].axisValue}m<br/>`;
                        params.sort((a, b) => (b.value[1] || 0) - (a.value[1] || 0)); 
                        params.forEach(param => {
                            if (param.value[1] !== null && param.value[1] !== undefined) {
                                tooltip += `${param.marker} ${param.seriesName}: ${param.value[1].toFixed(1)} Kmph<br/>`;
                            }
                        });
                        return tooltip;
                    }
                },
                toolbox: { 
                    show: true,
                    feature: {
                        dataZoom: { yAxisIndex: 'none' },
                        dataView: { readOnly: false },
                        magicType: { type: ['line', 'bar'] },
                        restore: {},
                        saveAsImage: {},
                        // Naya Legend Toggle Button
                        legendToggle: {
                            show: true,
                            title: 'Toggle Legend',
                            icon: 'path://M4,5h16v2H4V5zM4,11h16v2H4V11zM4,17h16v2H4V17z', // List icon
                            onclick: function () {
                                const currentOption = myChart.getOption();
                                const isLegendVisible = currentOption.legend[0].show;
                                myChart.setOption({
                                    legend: {
                                        show: !isLegendVisible
                                    }
                                });
                            }
                        }
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', top: '12%', containLabel: true },
                xAxis: { type: 'value', name: 'Distance to Stop (m)', min: 0, max: 800, inverse: true, axisLabel: { formatter: '{value} m' }, splitLine: { lineStyle: { type: 'dashed', color: '#eee' } } },
                yAxis: { type: 'value', name: 'Speed (Kmph)', min: 0, max: 120, axisLabel: { formatter: '{value} Kmph' }, splitLine: { lineStyle: { type: 'dashed', color: '#eee' } } },
                
                title: { text: 'Stop Approach Speed Analysis' },
                // Legend default mein hide rahega
                legend: { show: false, data: [], type: 'scroll', top: 30, padding: 5 },
                series: []
            };
            
            myChart.setOption(chartBaseOption);
        }

        // --- TOGGLE AVERAGE PROFILE FUNCTION ---
        function toggleAverageProfile() {
            showOnlyAverage = !showOnlyAverage;
            document.getElementById('toggle-average-btn').textContent = showOnlyAverage ? 'Show All Profiles' : 'Show Only Average Profile';
            updateChart();
        }

        // --- 3. GOOGLE SHEETS API SE DATA LOAD KARNA ---
        async function loadAndProcessData() {
            try {
                await new Promise((resolve) => gapi.load('client', resolve));
                await gapi.client.init({
                    'apiKey': API_KEY,
                    'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: RANGE,
                });
                const rawData = response.result.values;
                if (!rawData || rawData.length === 0) { throw new Error("No data found in sheet."); }
                
                preprocessData(rawData);
                populateFilters(); 
                setupAllFilterLogic(); 

                loadingDiv.style.display = 'none'; 
                filtersPanel.style.display = 'flex'; 

            } catch (error) {
                console.error('Error loading data from Google Sheets API:', error);
                let errorMsg = "Error loading data. Check console (F12) for details.";
                if (error.result && error.result.error) {
                    if (error.result.error.code === 403) { errorMsg = "Error: Google Sheets API is not enabled or API key is wrong."; }
                    else if (error.result.error.code === 404) { errorMsg = "Error: Sheet ID not found."; }
                }
                loadingDiv.innerText = errorMsg;
            }
        }

        // --- 4. DATA PRE-PROCESSING ---
        function preprocessData(rawData) {
            processedData = [];
            lpSet.clear();
            locationSet.clear();
            let currentLpId = null;
            let currentRakeType = null;

            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || row.length < 30) continue; 
                
                const lpId = (row[COLS.LP_ID] || "").trim();
                if (lpId !== "") { currentLpId = lpId; }
                
                const rakeType = (row[COLS.RAKE_TYPE] || "").trim().toUpperCase();
                if (rakeType !== "") { currentRakeType = rakeType; }

                const stopLocation = (row[COLS.STOP_LOCATION] || "").trim();
                if (stopLocation === "" || !isNaN(stopLocation)) { continue; }

                if (currentLpId) lpSet.add(currentLpId);
                locationSet.add(stopLocation);

                let s800 = parseFloat(row[COLS.SPEED_800]);
                let s500 = parseFloat(row[COLS.SPEED_500]);
                let s100 = parseFloat(row[COLS.SPEED_100]);
                let s50 = parseFloat(row[COLS.SPEED_50]);

                s800 = isNaN(s800) ? null : s800;
                s500 = isNaN(s500) ? null : s500;
                s100 = isNaN(s100) ? null : s100;
                s50 = isNaN(s50) ? null : s50;
                
                const graphData = [[800, s800], [500, s500], [100, s100], [50, s50], [0, 0]];

                processedData.push({
                    lpId: currentLpId,
                    location: stopLocation,
                    rakeType: currentRakeType, 
                    km: row[COLS.KM] || '',
                    graphData: graphData
                });
            }
        }

        // --- 5. FILTERS KO UNIQUE VALUES SE BHARNA ---
        function populateFilters() {
            const lpList = document.getElementById('lp-filter-list');
            const locationList = document.getElementById('location-filter-list');
            
            // LP ID Filter Bharna
            let lpHtml = '<div><label><input type="checkbox" id="lp-all" class="filter-all" checked> <strong>ALL</strong></label></div>';
            [...lpSet].sort().forEach((lp, index) => {
                lpHtml += `<div><label><input type="checkbox" class="lp-item" value="${lp}" checked> ${lp}</label></div>`;
            });
            lpList.innerHTML = lpHtml;

            // Location Filter Bharna
            let locHtml = '<div><label><input type="checkbox" id="location-all" class="filter-all" checked> <strong>ALL</strong></label></div>';
            [...locationSet].sort().forEach((loc, index) => {
                locHtml += `<div><label><input type="checkbox" class="location-item" value="${loc}" checked> ${loc}</label></div>`;
            });
            locationList.innerHTML = locHtml;
        }

        // --- 6. NAYA FUNCTION: SEARCH BOX KE LIYE ---
        function filterCheckboxes(inputId, listId) {
            let input = document.getElementById(inputId);
            let filter = input.value.toUpperCase();
            let list = document.getElementById(listId);
            let items = list.getElementsByTagName('div');

            // i=1 se start karo taaki "ALL" checkbox hide na ho
            for (let i = 1; i < items.length; i++) {
                let label = items[i].getElementsByTagName('label')[0];
                if (label) {
                    let txtValue = label.textContent || label.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        items[i].style.display = "";
                    } else {
                        items[i].style.display = "none";
                    }
                }
            }
        }

        // --- 7. NAYA FUNCTION: SABHI "ALL" CHECKBOX LOGIC KE LIYE ---
        function setupAllFilterLogic() {
            // Yeh function "ALL" aur "item" checkboxes ke logic ko handle karega
            function setupCheckboxLogic(allCheckboxId, itemClassName) {
                const allCb = document.getElementById(allCheckboxId);
                const itemCbs = document.querySelectorAll(`.${itemClassName}`);

                allCb.addEventListener('change', () => {
                    itemCbs.forEach(cb => {
                        cb.checked = allCb.checked;
                    });
                });

                itemCbs.forEach(cb => {
                    cb.addEventListener('change', () => {
                        if (!cb.checked) {
                            allCb.checked = false;
                        } else if ([...itemCbs].every(c => c.checked)) {
                            allCb.checked = true;
                        }
                    });
                });
            }

            // Teeno filters par logic apply karo
            setupCheckboxLogic('lp-all', 'lp-item');
            setupCheckboxLogic('location-all', 'location-item');
            setupCheckboxLogic('rake-all', 'rake-item'); // Iske liye Rake HTML ko class deni hogi
            
            // Rake HTML ko update karo taaki class match ho
            document.querySelectorAll('#rake-filter input[type="checkbox"]:not(#rake-all)')
                    .forEach(cb => cb.classList.add('rake-item'));
        }

        // --- 8. AVERAGE LINE CALCULATE KARNA ---
        function calculateAverageSeries(filteredStops) {
            if (filteredStops.length === 0) return null;
            const sums = { 800: 0, 500: 0, 100: 0, 50: 0, 0: 0 };
            const counts = { 800: 0, 500: 0, 100: 0, 50: 0, 0: 0 };
            
            for (const stop of filteredStops) {
                for (const point of stop.graphData) {
                    const distance = point[0];
                    const speed = point[1];
                    if (sums.hasOwnProperty(distance) && speed !== null && speed !== undefined) { 
                        sums[distance] += speed; 
                        counts[distance]++; 
                    }
                }
            }
            
            const avgData = [
                [800, counts[800] > 0 ? sums[800] / counts[800] : null],
                [500, counts[500] > 0 ? sums[500] / counts[500] : null],
                [100, counts[100] > 0 ? sums[100] / counts[100] : null],
                [50, counts[50] > 0 ? sums[50] / counts[50] : null],
                [0, 0]
            ];

            return {
                name: `Average Profile (${filteredStops.length} stops)`,
                type: 'line', data: avgData, smooth: true, symbol: 'none',
                color: '#c23531', 
                lineStyle: { width: 4, type: 'dashed', color: '#c23531' },
                emphasis: { lineStyle: { width: 6 } }
            };
        }

        // --- 9. CHART UPDATE KARNA ---
        function updateChart() {
            
            // HELPER FUNCTION: Checked values nikalne ke liye
            function getCheckedValues(allCheckboxId, itemClassName) {
                if (document.getElementById(allCheckboxId).checked) {
                    return ['ALL']; 
                }
                let values = [];
                document.querySelectorAll(`.${itemClassName}:checked`).forEach(cb => {
                    values.push(cb.value);
                });
                return values;
            }

            // 1. Filter values lena
            const selectedLps = getCheckedValues('lp-all', 'lp-item');
            const selectedLocations = getCheckedValues('location-all', 'location-item');
            const selectedRakes = getCheckedValues('rake-all', 'rake-item');
            const allRakesChecked = document.getElementById('rake-all').checked;

            // 2. Data ko filter karna
            const filteredData = processedData.filter(stop => {
                const lpMatch = selectedLps.includes('ALL') || selectedLps.includes(stop.lpId);
                const locationMatch = selectedLocations.includes('ALL') || selectedLocations.includes(stop.location);
                
                // Rake match logic 
                let rakeMatch = false;
                if (allRakesChecked) {
                    rakeMatch = true; 
                } else {
                    rakeMatch = selectedRakes.includes(stop.rakeType);
                }
                
                return lpMatch && locationMatch && rakeMatch;
            });

            // Apply recent filter
            const recentValue = document.getElementById('recent-filter').value;
            let displayData = filteredData;
            if (recentValue !== 'all') {
                const N = parseInt(recentValue);
                displayData = filteredData.slice(-N);
            }

            // 3. Graph ko dikhana aur resize karna
            chartDiv.style.display = 'block';
            myChart.resize(); 

            // 4. "No Data" check
            if (displayData.length === 0) {
                myChart.setOption({
                    ...chartBaseOption,
                    title: { text: 'No matching data found', subtext: 'Please adjust your filter selection.', left: 'center', top: 'center' },
                    legend: { data: [] },
                    series: [] 
                }, true);
                return; 
            }
            
            // 5. Average calculate karo
            const avgSeries = calculateAverageSeries(displayData);
            let finalSeries = [];
            if (avgSeries) {
                finalSeries.push(avgSeries); 
            }

            let subtext = null; 

            // 6. Check karo ki lines LIMIT se zyaada toh nahi hain aur average only mode
            if (showOnlyAverage) {
                subtext = `Showing only average of ${displayData.length} stops.`;
            } else if (displayData.length > LINE_LIMIT) {
                subtext = `Showing average of ${displayData.length} stops. (Too many to show individually)`;
            } else {
                const seriesData = displayData.map((stop, index) => {
                    return {
                        name: `LP ${stop.lpId} @ ${stop.location} (KM ${stop.km})`,
                        type: 'line', smooth: true, symbol: 'none', 
                        lineStyle: { width: 2, opacity: 0.7 },
                        data: stop.graphData,
                        emphasis: { focus: 'series', lineStyle: { width: 4, opacity: 1 } }
                    };
                });
                finalSeries.push(...seriesData);
            }
            // 7. Chart ko naye data se update karo
            myChart.setOption({
                ...chartBaseOption,
                title: { 
                    text: 'Stop Approach Speed Analysis', 
                    subtext: subtext, 
                    left: 'auto', 
                    top: 'auto' 
                },
                legend: { 
                    ...chartBaseOption.legend,
                    data: finalSeries.map(s => s.name)
                },
                series: finalSeries
            }, true);
        }

    </script>
</body>

</html>

