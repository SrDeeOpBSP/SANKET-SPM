<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPM Analysis Report</title>
    <link href="report.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* === Root Variables for Theming === */
        :root {
            --font-main: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --text-muted: #6c757d;
            --accent-color: #0056b3;
            --accent-glow: rgba(0, 86, 179, 0.2);
            --border-color: #dee2e6;
            --box-bg: #ffffff;
            --input-bg: #f8f9fa;
            --success-color: #198754;
            --danger-color: #dc3545;
        }

        /* === General Body and Layout === */
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--box-bg);
            padding: 25px 40px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        /* === Header and Logo === */
        .logo {
            display: block;
            margin: 0 auto 15px auto;
            width: 250px;
            height: auto;
        }

        h1, h3, h4 { text-align: center; }

        h1 {
            color: var(--accent-color);
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        h2 {
            color: var(--text-color);
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            font-size: 1.6rem;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        h3 {
            color: var(--text-muted);
            font-weight: 400;
            margin: 5px 0 20px 0;
        }

        /* === Loading Spinner === */
        .loading-overlay {
            display: flex;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--accent-color);
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === Buttons (Download & Back) === */
        .download-button, .back-button {
            display: none; /* Initially hidden */
            width: 48%;
            margin-top: 25px;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .download-button {
            background: linear-gradient(45deg, #28a745, #218838);
        }
        .back-button {
            background: linear-gradient(45deg, #fd7e14, #e85d0c);
            float: right;
        }
        .download-button:hover, .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .download-button:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* === Other Elements === */
        .error-message { color: var(--danger-color); text-align: center; margin: 20px; font-size: 1.2rem; }
        canvas { max-width: 100%; width: 800px !important; height: 400px !important; margin: 20px auto; display: block; border: 1px solid var(--border-color); border-radius: 8px; }
        td.system-analysis { word-wrap: break-word; white-space: normal; }
        select.cli-analysis, input.cli-remark-input { width: 100%; padding: 5px; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; box-sizing: border-box; }

        /* =================================== */
        /* === CLI Observation Tab Styling === */
        /* =================================== */
        #cli-observation textarea,
        #cli-observation input[type="text"],
        #cli-observation input[type="number"] {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: var(--font-main);
            line-height: 1.5;
        }
        #cli-observation textarea:focus,
        #cli-observation input[type="text"]:focus,
        #cli-observation input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        #totalAbnormality {
            font-weight: bold;
            font-size: 1.8rem;
            text-align: center;
            cursor: not-allowed;
            background-color: #e9ecef;
            color: var(--accent-color);
            border: 2px dashed var(--accent-color);
        }

        #abnormalities-checkbox-container {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-top: 15px;
        }

        .abnormality-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        .abnormality-group:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .abnormality-group label {
            display: flex;
            align-items: center;
            min-width: 280px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            flex-shrink: 0;
        }
        .abnormality-group input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            height: 22px;
            width: 22px;
            background-color: #fff;
            border: 2px solid #adb5bd;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 15px;
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        .abnormality-group input[type="checkbox"]:hover {
            border-color: var(--accent-color);
        }
        .abnormality-group input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .abnormality-group input[type="checkbox"]:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            font-size: 16px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -52%);
        }

        .abnormality-group input[type="text"] {
            flex-grow: 1;
            margin-left: 20px;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="report-container">
        <img src="railway logo.png" alt="Railway Logo" class="logo">
        <h1>SANKET</h1>
        <h3>(SPM Analysis and Navigation KPA Extraction Tool)</h3>
        <h4>(Designed and Developed by Electrical(OP) Bilaspur S.E.C.Railway)</h4>
        <div class="tabs">
            <button class="tab-button active" data-tab="train-details">Train Details</button>
            <button class="tab-button" data-tab="crew-details">Crew Details</button>
            <button class="tab-button" data-tab="brake-tests">Brake Tests</button>
            <button class="tab-button" data-tab="crew-call">Crew Call Analysis</button>
            <button class="tab-button" data-tab="driving-analysis">Driving Analysis</button>
            <button class="tab-button" data-tab="speed-distance">Speed vs. Distance</button>
            <button class="tab-button" data-tab="station-timings">Station Timings</button>
            <button class="tab-button" data-tab="speed-time">Speed vs. Time</button>
             <button class="tab-button" data-tab="speed-range-summary">Speed Range Summary</button>
            <button class="tab-button" data-tab="violations">Violations</button>
            <button class="tab-button" data-tab="cli-observation">CLI Observation</button>
        </div>
        <div id="reportContent" class="tab-content">
            <div id="train-details" class="tab-pane active"></div>
            <div id="crew-details" class="tab-pane"></div>
            <div id="brake-tests" class="tab-pane"></div>
            <div id="crew-call" class="tab-pane"></div>
            <div id="driving-analysis" class="tab-pane"></div>
            <div id="speed-distance" class="tab-pane"><canvas id="stopChart"></canvas></div>
            <div id="station-timings" class="tab-pane"></div>
            <div id="speed-time" class="tab-pane"><canvas id="speedChart"></canvas></div>
            <div id="speed-range-summary" class="tab-pane"></div>
            <div id="violations" class="tab-pane"></div>
           <div id="cli-observation" class="tab-pane">
        <h2>OVERALL OBSERVATION OF CLI</h2>
        <div style="background-color: #fffbe6; border-left: 5px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 5px; color: #664d03;">
          <h4 style="margin-top: 0; font-weight: bold;">कृपया ध्यान दें!</h4>
          <p style="margin-bottom: 0;">कृपया रिपोर्ट को ध्यान से पढ़ें। <strong>डाउनलोड बटन</strong> दबाने से पहले सभी विवरणों की समीक्षा कर लें। जैसे ही आप डाउनलोड पर क्लिक करेंगे, यह डेटा अंतिम रूप से गूगल शीट में सहेज दिया जाएगा और आप मुख्य पृष्ठ पर वापस चले जाएँगे। यह प्रक्रिया डुप्लीकेट एंट्री को रोकने के लिए की गई है, कृपया डुप्लीकेट एंट्री करने से बचें।</p>
        </div>
        
        <textarea id="cliRemarks" rows="4" placeholder="Please enter at least 15 words in OVERALL OBSERVATION OF CLI....."></textarea>

        <h3 style="margin-top: 20px;">Detail of Abnormalities</h3>
        <div id="abnormalities-checkbox-container">
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-bft-nd" data-text-id="">BFT not done</label>
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-bpt-nd" data-text-id="">BPT not done</label>
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-bft-rule" data-text-id="txt-bft-rule">BFT not done as per rule</label>
            <input type="text" id="txt-bft-rule" placeholder="Enter remark for BFT not done as per rule,e.g BFT done at 25Kmph which is above 20Kmph.">
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-bpt-rule" data-text-id="txt-bpt-rule">BPT not done as per rule</label>
            <input type="text" id="txt-bpt-rule" placeholder="Enter remark for BPT not done as per rule,e.g BFT done at 75Kmph which is above 70Kmph.">
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-late-ctrl" data-text-id="txt-late-ctrl">Late Controlling</label>
            <input type="text" id="txt-late-ctrl" placeholder="Enter remark for Late Controlling, e.g Speed is more than 60Kmph at 1000m">
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-overspeed" data-text-id="txt-overspeed">Over speeding</label>
            <input type="text" id="txt-overspeed" placeholder="Enter remark for Over speeding,e.g Speed Exceeded 110Kmph for 60Sec between in AKT-NIA">
          </div>
          <div class="abnormality-group">
            <label><input type="checkbox" id="chk-others" data-text-id="txt-others">Other Abnormalities</label>
            <input type="text" id="txt-others" placeholder="Enter remark for Other Abnormalities,e.g. SPM data not fed,...etc">
          </div>
        </div>
        
        <textarea id="cliAbnormalities" rows="4" style="display:none;"></textarea>
        
        <h3 style="margin-top: 20px;">Number of Abnormalities Found</h3>
        <input type="number" id="totalAbnormality" placeholder="This will be auto-counted" min="0" readonly style="background-color: #e9ecef;">
        
        <h3 style="margin-top: 20px;">Action Taken</h3>
        <textarea id="actionTaken" rows="4" placeholder="Describe the action taken..."></textarea>
      </div>
      </div> 
    <button id="downloadReport" class="download-button">Download Report</button>
    <button id="backToForm" class="back-button">Back to Form</button>

  </div>
       
    <script>
        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        // Load report data
        let previousAbnormalityCounts = {};
        let reportData;
        try {
            reportData = JSON.parse(localStorage.getItem('spmReportData') || '{}');
            console.log('Retrieved reportData:', reportData);
            console.log('Speed Chart Config:', reportData.speedChartConfig);
            console.log('Stop Chart Config:', reportData.stopChartConfig);
            console.log('Speed Chart Image:', reportData.speedChartImage ? 'Present' : 'Missing');
            console.log('Stop Chart Image:', reportData.stopChartImage ? 'Present' : 'Missing');
        } catch (error) {
            console.error('Error parsing reportData:', error);
            reportData = {};
        }

        // Include spmConfig for brake tests
        const spmConfig = {
            brakeTests: {
                GOODS: { bft: { minSpeed: 20, maxSpeed: 30 }, bpt: { minSpeed: 40, maxSpeed: 50 } },
                COACHING: { bft: { minSpeed: 20, maxSpeed: 30 }, bpt: { minSpeed: 50, maxSpeed: 60 } },
                MEMU: { bft: { minSpeed: 20, maxSpeed: 30 }, bpt: { minSpeed: 50, maxSpeed: 60 } }
            }
        };

        // Render report
        function renderReport() {
            if (!Object.keys(reportData).length) {
                document.getElementById('reportContent').innerHTML = '<p class="error-message">No report data available. Please return to the form and try again.</p>';
                loadingOverlay.style.display = 'none';
                return;
            }

            console.log('Rendering report with data:', reportData);

            // Train Details
            document.getElementById('train-details').innerHTML = `
                <h2>Train Details</h2>
                <table class="report-table">
                    <tr><th>Parameters</th><th>Details</th></tr>
                    ${reportData.trainDetails?.map(detail => `
                        <tr><td>${detail.label}</td><td>${detail.value}</td></tr>
                    `).join('') || '<tr><td colspan="2">No data available</td></tr>'}
                </table>
            `;

            // Crew Details
           // Crew Details
            document.getElementById('crew-details').innerHTML = `
                <h2>Crew Details</h2>
                <div class="crew-details-container">
                    <div>
                        <h3>LP Details</h3>
                        <ul>
                            ${reportData.lpDetails?.map(detail => `<li>${detail}</li>`).join('') || '<li>No data available</li>'}
                        </ul>
                    </div>
                    <div>
                        <h3>ALP Details</h3>
                        <ul>
                            ${reportData.alpDetails?.map(detail => `<li>${detail}</li>`).join('') || '<li>No data available</li>'}
                        </ul>
                    </div>
                </div>
                <h3>Total Stops: ${reportData.stopCount || 0}</h3>

                <div id="lp-abnormalities-section" style="margin-top: 25px; border-top: 1px solid #ccc; padding-top: 15px;">
                    <h3>Previous 10 Abnormalities of Loco Pilot</h3>
                    <div id="lp-abnormalities-container">
                        <p>Loading previous records...</p>
                    </div>
                </div>
            `;

            // Fetch and display the abnormalities from Google Sheet
            if (reportData.lpDetails && reportData.lpDetails.length > 0) {
                // Extracts the ID from a string like "LP ID: P12345"
                const lpId = reportData.lpDetails[0].split(': ')[1]?.trim();
                fetchAndDisplayAbnormalities(lpId);
            }
            // Brake Tests
            const rakeType = reportData.trainDetails?.find(d => d.label === 'Type of Rake')?.value || 'GOODS';
            document.getElementById('brake-tests').innerHTML = `
                <h2>Brake Tests</h2>
                <table class="report-table">
                    <tr>
                        <th>Test Type</th>
                        <th>Start Time</th>
                        <th>Speed Reduced</th>
                        <th>Time Taken</th>
                        <th>End Time</th>
                        <th>CLI Remark</th>
                    </tr>
                    <tr>
                        <td>Brake Feel Test (BFT)</td>
                        <td>${reportData.bftDetails?.time || 'BFT not done'}</td>
                        <td>${reportData.bftDetails?.time ? `${reportData.bftDetails.startSpeed} kmph to ${reportData.bftDetails.endSpeed} kmph (${reportData.bftDetails.reduction} kmph)` : 'N/A'}</td>
                        <td>${reportData.bftDetails?.time ? `${reportData.bftDetails.timeTaken} sec` : 'N/A'}</td>
                        <td>${reportData.bftDetails?.time ? reportData.bftDetails.endTime : 'N/A'}</td>
                        <td><input type="text" id="bftRemark" class="cli-remark-input" placeholder="Enter remark..."></td>
                    </tr>
                    <tr>
                        <td>Brake Power Test (BPT)</td>
                        <td>${reportData.bptDetails?.time || 'BPT not done'}</td>
                        <td>${reportData.bptDetails?.time ? `${reportData.bptDetails.startSpeed} kmph to ${reportData.bptDetails.endSpeed} kmph (${reportData.bptDetails.reduction} kmph)` : 'N/A'}</td>
                        <td>${reportData.bptDetails?.time ? `${reportData.bptDetails.timeTaken} sec` : 'N/A'}</td>
                        <td>${reportData.bptDetails?.time ? reportData.bptDetails.endTime : 'N/A'}</td>
                        <td><input type="text" id="bptRemark" class="cli-remark-input" placeholder="Enter remark..."></td>
                    </tr>
                </table>
            `;

            // Crew Call Analysis
           const crewCallContent = (reportData.crewCallData && reportData.crewCallData.length > 0)
                ? reportData.crewCallData.map(row => `
                    <tr>
                        <td>${row.designation}</td>
                        <td>${row.totalDuration}</td>
                        <td>${row.runDuration}</td>
                        <td>${row.stopDuration}</td>
                        <td>${row.maxSpeed}</td>
                        <td>${row.toNumbers}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="6" style="text-align:center;">No CUG data provided</td></tr>';

            document.getElementById('crew-call').innerHTML = `
                <h2>Crew Call Analysis</h2>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Designation</th><th>Total Duration</th><th>Call on Run</th><th>Call on Stop</th><th>Max Speed</th><th>To Mobile Number</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${crewCallContent}
                    </tbody>
                </table>
            `;

            // Driving Analysis (MODIFIED SECTION)
        document.getElementById('driving-analysis').innerHTML = `
              <h2>Driving Analysis</h2>
    ${reportData.stops?.length > 0 ? `
        <table class="report-table">
            <tr>
                <th>Sr. No.</th><th>Stop Location</th><th>Stop Timing</th><th>Start Timing</th><th>Km</th>
                <th>1000m</th><th>800m</th><th>500m</th><th>100m</th><th>50m</th>
                <th>System Generated Analysis</th>
                <th>CLI Remark</th>
            </tr>
            ${reportData.stops.map((stop, index) => `
                <tr>
                    <td>${stop.group}</td>
                    <td>${stop.stopLocation}</td>
                    <td>${stop.timeString}</td>
                    <td>${stop.startTiming}</td>
                    <td>${(stop.kilometer / 1000).toFixed(2)}</td>
                    <td>${stop.speedsBefore[0] ? parseFloat(stop.speedsBefore[0]).toFixed(0) : 'N/A'}</td>
                    <td>${stop.speedsBefore[1] ? parseFloat(stop.speedsBefore[1]).toFixed(0) : 'N/A'}</td>
                    <td>${stop.speedsBefore[2] ? parseFloat(stop.speedsBefore[2]).toFixed(0) : 'N/A'}</td>
                    <td>${stop.speedsBefore[3] ? parseFloat(stop.speedsBefore[3]).toFixed(0) : 'N/A'}</td>
                    <td>${stop.speedsBefore[4] ? parseFloat(stop.speedsBefore[4]).toFixed(0) : 'N/A'}</td>
                    <td class="system-analysis">
                        <select class="cli-analysis system-analysis-dropdown" data-stop-index="${index}">
                            <option value="Smooth" ${stop.brakingTechnique === 'Smooth' ? 'selected' : ''}>Smooth</option>
                            <option value="Late" ${stop.brakingTechnique === 'Late' ? 'selected' : ''}>Late</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="cli-remark-input-row" data-stop-index="${index}" placeholder="Enter remark..." style="width: 95%;">
                    </td>
                </tr>
            `).join('')}
        </table>
    ` : '<p>No stops found in the selected range.</p>'}
        `;
            // Station Timings
            document.getElementById('station-timings').innerHTML = `
                <h2>Station Timings</h2>
                <table class="report-table">
                    <tr><th>Station</th><th>Arrival</th><th>Departure</th></tr>
                    ${reportData.stationStops?.map(stop => `
                        <tr>
                            <td>${stop.station}</td>
                            <td>${stop.arrival}</td>
                            <td>${stop.departure}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="3">No data available</td></tr>'}
                </table>
            `;
             // Speed Range Summary
           // Speed Range Summary
            document.getElementById('speed-range-summary').innerHTML = `
                <h2>Distance Covered During Speed Range</h2>
                ${reportData.speedRangeSummary?.summary?.length > 0 ? `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Speed Range</th>
                                <th>Distance Covered (KM)</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.speedRangeSummary.summary.map(detail => `
                                <tr>
                                    <td>${detail.speedRange}</td>
                                    <td>${detail.distance}</td>
                                    <td>${detail.percentage}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>Total Distance Covered</strong></td>
                                <td><strong>${reportData.speedRangeSummary.totalDistance}</strong></td>
                                <td><strong>100.00%</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                ` : '<p>No data available for speed range summary.</p>'}

                <h2 style="margin-top: 30px;">Section-wise Speed Summary</h2>
                ${reportData.sectionSpeedSummary?.length > 0 ? `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Section</th>
                                <th>Most Frequent Speed (Kmph)</th>
                                <th>Maximum Speed (Kmph)</th>
                                <th>Average Speed (Kmph)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.sectionSpeedSummary.map(detail => `
                                <tr>
                                    <td>${detail.section}</td>
                                    <td>${detail.modeSpeed}</td>
                                    <td>${detail.maxSpeed}</td>
                                    <td>${detail.averageSpeed}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>No data available for average speed summary.</p>'}
            `;

            // Violations
            document.getElementById('violations').innerHTML = `
                <h2>Overspeed Details</h2>
                ${reportData.overSpeedDetails?.length > 0 ? `
                    <table class="report-table">
                        <tr><th>Section</th><th>Time Range</th><th>Speed Range (kmph)</th></tr>
                        ${reportData.overSpeedDetails.map(detail => `
                            <tr>
                                <td>${detail.section}</td>
                                <td>${detail.timeRange}</td>
                                <td>${detail.speedRange}</td>
                            </tr>
                        `).join('')}
                    </table>
                ` : '<p>No overspeeding found.</p>'}
                <h2>Suspected Wheel Slip Details</h2>
                ${reportData.wheelSlipDetails?.length > 0 ? `
                    <table class="report-table">
                        <tr><th>Section</th><th>Time Range</th><th>Speed Range (kmph)</th></tr>
                        ${reportData.wheelSlipDetails.map(detail => `
                            <tr>
                                <td>${detail.section}</td>
                                <td>${detail.timeRange}</td>
                                <td>${detail.speedRange}</td>
                            </tr>
                        `).join('')}
                    </table>
                ` : '<p>No suspected wheel slips found.</p>'}
                <h2>Suspected Wheel Skid Details</h2>
                ${reportData.wheelSkidDetails?.length > 0 ? `
                    <table class="report-table">
                        <tr><th>Section</th><th>Time Range</th><th>Speed Range (kmph)</th></tr>
                        ${reportData.wheelSkidDetails.map(detail => `
                            <tr>
                                <td>${detail.section}</td>
                                <td>${detail.timeRange}</td>
                                <td>${detail.speedRange}</td>
                            </tr>
                        `).join('')}
                    </table>
                ` : '<p>No suspected wheel skids found.</p>'}
            `;

            // Render charts with delay
            setTimeout(() => {
                try {
                    const speedCanvas = document.getElementById('speedChart');
                    if (!speedCanvas) {
                        console.error('Speed Chart canvas not found');
                        document.getElementById('speed-time').innerHTML += '<p class="error-message">Speed vs. Time chart canvas not found.</p>';
                    } else {
                        let speedLabels = reportData.speedChartConfig?.labels || ['10:00', '10:01', '10:02', '10:03', '10:04'];
                        let speedData = reportData.speedChartConfig?.speeds || [0, 10, 20, 15, 0];
                        if (!reportData.speedChartConfig?.labels?.length || !reportData.speedChartConfig?.speeds?.length) {
                            console.warn('No valid data for Speed vs Time chart. Using fallback.');
                        }
                        console.log('Rendering Speed vs Time Chart with labels:', speedLabels.slice(0, 5), 'data:', speedData.slice(0, 5));
                        new Chart(speedCanvas.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: speedLabels,
                                datasets: [{
                                    label: 'Speed',
                                    data: speedData,
                                    borderColor: '#00008B',
                                    backgroundColor: 'rgba(0, 0, 139, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { 
                                        title: { display: true, text: 'Time' }, 
                                        grid: { color: '#F5F5F5' },
                                        ticks: { maxTicksLimit: 12 }
                                    },
                                    y: { 
                                        title: { display: true, text: 'Speed (kmph)' }, 
                                        beginAtZero: true, 
                                        ticks: { stepSize: 10 } 
                                    }
                                },
                                plugins: { legend: { display: false } }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error rendering Speed vs Time Chart:', error);
                    document.getElementById('speed-time').innerHTML += '<p class="error-message">Failed to render Speed vs. Time chart.</p>';
                }

                try {
                    const stopCanvas = document.getElementById('stopChart');
                    if (!stopCanvas) {
                        console.error('Stop Chart canvas not found');
                        document.getElementById('speed-distance').innerHTML += '<p class="error-message">Speed vs. Distance chart canvas not found.</p>';
                    } else {
                        let stopLabels = reportData.stopChartConfig?.labels || [1000, 900, 800, 700, 600, 500, 400, 300, 200, 100, 0];
                        let stopDatasets = reportData.stopChartConfig?.datasets || [{
                            label: 'Test Stop',
                            data: [30, 28, 25, 20, 15, 10, 8, 5, 3, 1, 0],
                            borderColor: '#FF0000',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.2,
                            borderWidth: 2,
                            pointRadius: 3
                        }];
                        if (!reportData.stopChartConfig?.datasets?.length || !reportData.stopChartConfig?.labels?.length) {
                            console.warn('No valid data for Speed vs Distance chart. Using fallback.');
                        }
                        console.log('Rendering Speed vs Distance Chart with labels:', stopLabels, 'datasets:', stopDatasets.length);
                        new Chart(stopCanvas.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: stopLabels,
                                datasets: stopDatasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { 
                                        title: { display: true, text: 'Distance Before Stop (m)' }, 
                                        ticks: { stepSize: 100 } 
                                    },
                                    y: { 
                                        title: { display: true, text: 'Speed (kmph)' }, 
                                        beginAtZero: true, 
                                        ticks: { stepSize: 10 } 
                                    }
                                },
                                plugins: { 
                                    legend: { display: true, position: 'top' }, 
                                    title: { display: true, text: 'Speed vs. Distance Before Stop' } 
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error rendering Speed vs Distance Chart:', error);
                    document.getElementById('speed-distance').innerHTML += '<p class="error-message">Failed to render Speed vs. Distance chart.</p>';
                }

                loadingOverlay.style.display = 'none';
            }, 500);
        }

        // Initialize tabs
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const panes = document.querySelectorAll('.tab-pane');
            const downloadBtn = document.getElementById('downloadReport');
            const backBtn = document.getElementById('backToForm');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    panes.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');

                    // Buttons ko dikhane ya hide karne ka naya logic
                    if (tab.dataset.tab === 'cli-observation') {
                        downloadBtn.style.display = 'inline-block';
                        backBtn.style.display = 'inline-block';
                    } else {
                        downloadBtn.style.display = 'none';
                        backBtn.style.display = 'none';
                    }
                });
            });
        }
async function fetchAndDisplayAbnormalities(lpId) {
            const container = document.getElementById('lp-abnormalities-container');
            if (!lpId || lpId === 'N/A') {
                container.innerHTML = '<p>LP ID not provided.</p>';
                return;
            }
        
            const url = `https://sheets.googleapis.com/v4/spreadsheets/1XcmhgkXH0fQlUQG3oLmEUrVnUVk3p_gyYqBMPyXfGv0/values/Sheet1?key=AIzaSyAw23pJz0K9fZb2rRRAe2C2cJDilRc0Kac`;
        
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const data = await response.json();
                const rows = data.values || [];
        
                let lpFound = false;
                const abnormalities = [];
                // Reset global counts
                previousAbnormalityCounts = { bft_nd: 0, bpt_nd: 0, bft_rule: 0, bpt_rule: 0, late_ctrl: 0, overspeed: 0, others: 0 };
        
               rows.forEach(row => {
                    if (row[5]?.trim() === lpId) { // LP_ID_COL = 5
                        lpFound = true;
                        // --- CHANGED: COUNT_COL 39 se 40 (AO) ho gaya hai ---
                        if (row[38] && !isNaN(parseInt(row[40])) && parseInt(row[40]) > 0) abnormalities.push(row[38]); // ABNORMALITY_COL=38, COUNT_COL=40
                        // Sum up previous counts --- SABHI INDICES UPDATE HO GAYE HAIN ---
                        previousAbnormalityCounts.bft_nd += parseInt(row[42] || 0); // AQ=42 (was 41)
                        previousAbnormalityCounts.bpt_nd += parseInt(row[43] || 0); // AR=43 (was 42)
                        previousAbnormalityCounts.bft_rule += parseInt(row[44] || 0); // AS=44 (was 43)
                        previousAbnormalityCounts.bpt_rule += parseInt(row[45] || 0); // AT=45 (was 44)
                        previousAbnormalityCounts.late_ctrl += parseInt(row[46] || 0); // AU=46 (was 45)
                        previousAbnormalityCounts.overspeed += parseInt(row[47] || 0); // AV=47 (was 46)
                        previousAbnormalityCounts.others += parseInt(row[48] || 0); // AW=48 (was 47)
                    }
                });
                
                console.log("Fetched Previous Counts:", previousAbnormalityCounts);
        
                if (!lpFound) container.innerHTML = '<p style="font-weight: bold; color: #17a2b8;">No prior analysis records found.</p>';
                else if (abnormalities.length === 0) container.innerHTML = '<p style="font-weight: bold; color: #28a745;">NIL abnormality found previously.</p>';
                else container.innerHTML = `<ol>${abnormalities.slice(-10).reverse().map(ab => `<li>${ab}</li>`).join('')}</ol>`;
        
            } catch (error) {
                console.error('Error fetching abnormalities:', error);
                container.innerHTML = '<p style="color: #dc3545;">Could not fetch previous records.</p>';
            }
        }
        // PDF generation
        function generatePDF() {
            loadingOverlay.style.display = 'flex';
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - 2 * margin;

                 const checkPageOverflow = (currentY, spaceNeeded) => {
                   if (currentY + spaceNeeded > pageHeight - margin - 10) { // Yahan se pageLimit condition hata di gayi hai
                   doc.addPage();
                   return margin;
                   }
                   return currentY;
                };

               const addFooter = () => {
                    const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
                    const pageCount = doc.internal.getNumberOfPages();

                    // Normal text (Date and Page Number) ke liye font set karein
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.setFont('helvetica', 'normal');

                    // Left side mein date
                    doc.text(`Generated on: ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false })}`, margin, pageHeight - 10);

                    // Right side mein page number
                    doc.text(`Page ${currentPage} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });

                    // Center mein BOLD text
                    doc.setFont('helvetica', 'bold');
                    doc.text('Analysis Through Sanket 1.0', pageWidth / 2, pageHeight - 10, { align: 'center' });
                };

                const wrapText = (text, maxWidth, fontSize) => {
                    doc.setFontSize(fontSize);
                    return doc.splitTextToSize(text, maxWidth - 2);
                };

                let y = margin;
                doc.setFillColor(0, 51, 102);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('SPM Analysis Report', pageWidth / 2, 15, { align: 'center' });
                y += 30;

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                y = checkPageOverflow(y, 10);
                doc.text('Train Details', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 40, y + 2);
                y += 10;

                const colWidthsTrain = { label: 50, value: contentWidth - 50 };
                const totalTableWidthTrain = contentWidth;
                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthTrain, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('Parameters', margin + 2, y + 6);
                doc.text('Details', margin + colWidthsTrain.label + 2, y + 6);
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                reportData.trainDetails?.forEach((detail, index) => {
                    const rowData = [detail.label, detail.value];
                    const lines = rowData.map((text, idx) => wrapText(text, idx === 0 ? colWidthsTrain.label - 4 : colWidthsTrain.value - 4, 10));
                    const maxLines = Math.max(...lines.map(l => l.length));
                    const rowHeight = maxLines * 8;
                    y = checkPageOverflow(y, rowHeight);
                    doc.setFillColor(index % 2 === 0 ? 220 : 240);
                    doc.rect(margin, y, totalTableWidthTrain, rowHeight, 'F');
                    doc.setDrawColor(150);
                    doc.rect(margin, y, totalTableWidthTrain, rowHeight);
                    let x = margin;
                    lines.forEach((lines, idx) => {
                        lines.forEach((line, lineIdx) => doc.text(line, x + 2, y + 6 + (lineIdx * 6)));
                        x += idx === 0 ? colWidthsTrain.label : colWidthsTrain.value;
                    });
                    y += rowHeight;
                });
                y += 10;

                doc.setFont('helvetica', 'bold');
                y = checkPageOverflow(y, 10);
                doc.text('Crew Details', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 40, y + 2);
                y += 10;

                const boxWidth = (contentWidth - 10) / 2;
                const boxHeight = 50;
                const lpBoxX = margin;
                const alpBoxX = margin + boxWidth + 10;
                doc.setDrawColor(0, 51, 102);
                doc.setLineWidth(0.5);
                doc.rect(lpBoxX, y, boxWidth, boxHeight);
                doc.rect(alpBoxX, y, boxWidth, boxHeight);
                doc.setFontSize(11);
                doc.setTextColor(0, 51, 102);
                doc.text('LP Details', lpBoxX + 5, y + 10);
                doc.text('ALP Details', alpBoxX + 5, y + 10);
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                reportData.lpDetails?.forEach((detail, index) => doc.text(detail, lpBoxX + 5, y + 20 + (index * 7)));
                reportData.alpDetails?.forEach((detail, index) => doc.text(detail, alpBoxX + 5, y + 20 + (index * 7)));
                y += boxHeight + 10;

                y = checkPageOverflow(y, 10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text(`Total Stops: ${reportData.stopCount || 0}`, margin, y);
                y += 10;

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Brake Tests', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 40, y + 2);
                y += 10;

                // Column widths update karein
                const colWidthsBrake = { testType: 30, startTime: 35, speedReduced: 40, timeTaken: 20, endTime: 35, cliRemark: 30 };
                const totalTableWidthBrake = Object.values(colWidthsBrake).reduce((a, b) => a + b, 0);
                doc.setFontSize(9);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthBrake, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                
                // Header text update karein
                let x = margin;
                doc.text('Test Type', x + 2, y + 6);
                x += colWidthsBrake.testType;
                doc.text('Start Time', x + 2, y + 6);
                x += colWidthsBrake.startTime;
                doc.text('Speed Reduced', x + 2, y + 6);
                x += colWidthsBrake.speedReduced;
                doc.text('Time Taken', x + 2, y + 6);
                x += colWidthsBrake.timeTaken;
                doc.text('End Time', x + 2, y + 6);
                x += colWidthsBrake.endTime;
                doc.text('CLI Remark', x + 2, y + 6);
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');

                // Input fields se remarks ki value lein
                const bftRemark = document.getElementById('bftRemark').value || '';
                const bptRemark = document.getElementById('bptRemark').value || '';

                // Row data mein remarks add karein
                const bftRowData = reportData.bftDetails?.time
                    ? ['Brake Feel Test (BFT)', reportData.bftDetails.time, `${reportData.bftDetails.startSpeed} kmph to ${reportData.bftDetails.endSpeed} kmph (${reportData.bftDetails.reduction} kmph)`, `${reportData.bftDetails.timeTaken} sec`, reportData.bftDetails.endTime, bftRemark]
                    : ['Brake Feel Test (BFT)', 'BFT not done', 'N/A', 'N/A', 'N/A', bftRemark];

                const bftLines = bftRowData.map((text, idx) => wrapText(String(text), Object.values(colWidthsBrake)[idx] - 4, 9));
                const bftMaxLines = Math.max(...bftLines.map(l => l.length));
                let rowHeight = bftMaxLines * 6;
                y = checkPageOverflow(y, rowHeight);
                doc.setFillColor(220);
                doc.rect(margin, y, totalTableWidthBrake, rowHeight, 'F');
                doc.setDrawColor(150);
                doc.rect(margin, y, totalTableWidthBrake, rowHeight);
                x = margin;
                bftLines.forEach((lines, idx) => {
                    lines.forEach((line, lineIdx) => doc.text(line, x + 2, y + 5 + (lineIdx * 5)));
                    x += Object.values(colWidthsBrake)[idx];
                });
                y += rowHeight;

                const bptRowData = reportData.bptDetails?.time
                    ? ['Brake Power Test (BPT)', reportData.bptDetails.time, `${reportData.bptDetails.startSpeed} kmph to ${reportData.bptDetails.endSpeed} kmph (${reportData.bptDetails.reduction} kmph)`, `${reportData.bptDetails.timeTaken} sec`, reportData.bptDetails.endTime, bptRemark]
                    : ['Brake Power Test (BPT)', 'BPT not done', 'N/A', 'N/A', 'N/A', bptRemark];
                
                const bptLines = bptRowData.map((text, idx) => wrapText(String(text), Object.values(colWidthsBrake)[idx] - 4, 9));
                const bptMaxLines = Math.max(...bptLines.map(l => l.length));
                rowHeight = bptMaxLines * 6;
                y = checkPageOverflow(y, rowHeight);
                doc.setFillColor(240);
                doc.rect(margin, y, totalTableWidthBrake, rowHeight, 'F');
                doc.setDrawColor(150);
                doc.rect(margin, y, totalTableWidthBrake, rowHeight);
                x = margin;
                bptLines.forEach((lines, idx) => {
                    lines.forEach((line, lineIdx) => doc.text(line, x + 2, y + 5 + (lineIdx * 5)));
                    x += Object.values(colWidthsBrake)[idx];
                });
                y += 10;

                if (doc.internal.getCurrentPageInfo().pageNumber < 2) {
                    doc.addPage();
                    y = margin;
                }

               doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Crew Call Analysis', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 50, y + 2);
                y += 10;

                const colWidthsCrew = { designation: 25, totalDuration: 30, runDuration: 30, stopDuration: 30, maxSpeed: 30, toNumbers: 45 };
                const totalTableWidthCrew = Object.values(colWidthsCrew).reduce((a, b) => a + b, 0);
                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthCrew, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                let x_crew = margin;
                doc.text('Designation', x_crew + 2, y + 6);
                x_crew += colWidthsCrew.designation;
                doc.text('Total Duration', x_crew + 2, y + 6);
                x_crew += colWidthsCrew.totalDuration;
                doc.text('Call on Run', x_crew + 2, y + 6);
                x_crew += colWidthsCrew.runDuration;
                doc.text('Call on Stop', x_crew + 2, y + 6);
                x_crew += colWidthsCrew.stopDuration;
                doc.text('Max Speed', x_crew + 2, y + 6);
                x_crew += colWidthsCrew.maxSpeed;
                doc.text('To Mobile Number', x_crew + 2, y + 6);
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                if (reportData.crewCallData && reportData.crewCallData.length > 0) {
                    reportData.crewCallData.forEach((row, idx) => {
                        const rowData = [row.designation, row.totalDuration, row.runDuration, row.stopDuration, row.maxSpeed, row.toNumbers];
                        const lines = rowData.map((text, i) => wrapText(String(text), Object.values(colWidthsCrew)[i] - 4, 10));
                        const maxLines = Math.max(...lines.map(l => l.length));
                        rowHeight = maxLines * 8;
                        y = checkPageOverflow(y, rowHeight);
                        doc.setFillColor(idx % 2 === 0 ? 220 : 240);
                        doc.rect(margin, y, totalTableWidthCrew, rowHeight, 'F');
                        x_crew = margin;
                        lines.forEach((lines, i) => {
                            lines.forEach((line, lineIdx) => doc.text(line, x_crew + 2, y + 6 + (lineIdx * 6)));
                            x_crew += Object.values(colWidthsCrew)[i];
                        });
                        y += rowHeight;
                    });
                } else {
                    y = checkPageOverflow(y, 8);
                    doc.text('No CUG data provided', margin + (totalTableWidthCrew / 2), y + 6, { align: 'center' });
                    y += 8;
                }
                y += 10;

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Driving Analysis', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 40, y + 2);
                y += 10;

                if (reportData.stops?.length > 0) {
                    const colWidthsStops = { srNo: 8, stopLocation: 22, stopTiming: 22, startTiming: 22, kilometer: 12, speed1000m: 12, speed800m: 12, speed500m: 12, speed100m: 12, speed50m: 12, systemAnalysis: 20, cliRemark: 23 };
                    const totalTableWidthStops = Object.values(colWidthsStops).reduce((a, b) => a + b, 0);
                    doc.setFontSize(10);
                    doc.setFillColor(0, 51, 102);

                    // Define headers and wrap them
                    const headers = [
    'Sr. No.', 'Stop Location', 'Stop Timing', 'Start Timing', 'Km',
    '1000m', '800m', '500m', '100m', '50m',
    'System Generated Analysis', 'CLI Remark'
];
                    const headerLines = headers.map((header, idx) => wrapText(header, Object.values(colWidthsStops)[idx] - 2, 10));
                    const maxHeaderLines = Math.max(...headerLines.map(lines => lines.length));
                    const headerRowHeight = maxHeaderLines * 6;

                    // Render header row
                    y = checkPageOverflow(y, headerRowHeight);
                    doc.rect(margin, y, totalTableWidthStops, headerRowHeight, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    x = margin;
                    headerLines.forEach((lines, idx) => {
                        const colWidth = Object.values(colWidthsStops)[idx];
                        const isNumeric = [0, 4, 5, 6, 7, 8].includes(idx);
                        lines.forEach((line, lineIdx) => {
                            doc.text(line, isNumeric ? x + colWidth / 2 : x + 2, y + 6 + (lineIdx * 5), isNumeric ? { align: 'center' } : null);
                        });
                        x += colWidth;
                    });
                    y += headerRowHeight;

                    // Draw vertical lines for header
                    doc.setDrawColor(255, 255, 255);
                    doc.setLineWidth(0.2);
                    x = margin;
                    for (let key in colWidthsStops) {
                        doc.line(x, y - headerRowHeight, x, y);
                        x += colWidthsStops[key];
                    }
                    doc.line(x, y - headerRowHeight, x, y);

                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    const cliAnalysisSelections = Array.from(document.querySelectorAll('.cli-analysis')).map(select => select.value);
                   reportData.stops.forEach((stop, index) => {
    // --- YEH NAYA CODE HAI ---
    // "System Analysis" dropdown se current value uthao
    const systemAnalysisSelect = document.querySelector(`.system-analysis-dropdown[data-stop-index="${index}"]`);
    const finalSystemAnalysis = systemAnalysisSelect ? systemAnalysisSelect.value : stop.brakingTechnique;

    // "CLI Remark" input field se current value uthao
    const cliRemarkInput = document.querySelector(`.cli-remark-input-row[data-stop-index="${index}"]`);
    const cliRemark = cliRemarkInput ? cliRemarkInput.value.trim() : 'NA';
    // --- NAYA CODE YAHAN KHATAM ---

    // ab rowData ko nayi values ke saath banao
    const rowData = [
    `${stop.group}`, stop.stopLocation, stop.timeString, stop.startTiming,
    `${(stop.kilometer / 1000).toFixed(3)}`,
    stop.speedsBefore[0] ? parseFloat(stop.speedsBefore[0]).toFixed(0) : 'N/A', // 1000m
    stop.speedsBefore[1] ? parseFloat(stop.speedsBefore[1]).toFixed(0) : 'N/A', // 800m
    stop.speedsBefore[2] ? parseFloat(stop.speedsBefore[2]).toFixed(0) : 'N/A', // 500m
    stop.speedsBefore[3] ? parseFloat(stop.speedsBefore[3]).toFixed(0) : 'N/A', // 100m
    stop.speedsBefore[4] ? parseFloat(stop.speedsBefore[4]).toFixed(0) : 'N/A', // 50m
    finalSystemAnalysis,
    cliRemark
];
                        const lines = rowData.map((text, idx) => wrapText(text, Object.values(colWidthsStops)[idx] - 2, 10));
                        const maxLines = Math.max(...lines.map(l => l.length));
                        rowHeight = maxLines * 5;
                        y = checkPageOverflow(y, rowHeight);
                        doc.setFillColor(index % 2 === 0 ? 245 : 255);
                        doc.rect(margin, y, totalTableWidthStops, rowHeight, 'F');
                        doc.setDrawColor(200);
                        doc.setLineWidth(0.1);
                        doc.rect(margin, y, totalTableWidthStops, rowHeight);
                        x = margin;
                        for (let key in colWidthsStops) {
                            doc.line(x, y, x, y + rowHeight);
                            x += colWidthsStops[key];
                        }
                        doc.line(x, y, x, y + rowHeight);
                        x = margin;
                        lines.forEach((lines, idx) => {
                            const colWidth = Object.values(colWidthsStops)[idx];
                            const isNumeric = [0, 4, 5, 6, 7, 8].includes(idx);
                            lines.forEach((line, lineIdx) => {
                                doc.text(line, isNumeric ? x + colWidth / 2 : x + 2, y + 4 + (lineIdx * 5), isNumeric ? { align: 'center' } : null);
                            });
                            x += colWidth;
                        });
                        y += rowHeight;
                    });
                    doc.line(margin, y, margin + totalTableWidthStops, y);
                    y += 10;
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    y = checkPageOverflow(y, 10);
                    doc.text('No stops found in the selected range.', margin, y);
                    y += 10;
                }

              doc.addPage();
               y = margin;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 100);
                doc.text('Speed vs. Distance Before Stop', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 60, y + 2);
                y += 10;

                if (reportData.stopChartImage) {
                    try {
                        doc.addImage(reportData.stopChartImage, 'PNG', margin, y, contentWidth * 0.8, contentWidth * 0.8 * (600 / 400));
                        y += contentWidth * 0.8 * (600 / 400) + 10;
                    } catch (error) {
                        console.error('Error adding stop chart to PDF:', error);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(255, 0, 0);
                        doc.text('Failed to render stop graph.', margin, y);
                        y += 10;
                    }
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(255, 0, 0);
                    doc.text('No data available for the stop graph.', margin, y);
                    y += 10;
                }

                doc.addPage();
                y = margin;

                y = checkPageOverflow(y, 10);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('Station Timings', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 50, y + 2);
                y += 10;

                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('Station', margin + 5, y + 6);
                doc.text('Arrival', margin + 40, y + 6);
                doc.text('Departure', margin + 100, y + 6);
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                reportData.stationStops?.forEach((stop, index) => {
                    y = checkPageOverflow(y, 8);
                    doc.setFillColor(index % 2 === 0 ? 220 : 240);
                    doc.rect(margin, y, contentWidth, 8, 'F');
                    doc.setDrawColor(150);
                    doc.rect(margin, y, contentWidth, 8);
                    doc.text(stop.station, margin + 5, y + 6);
                    doc.text(stop.arrival || 'N/A', margin + 40, y + 6);
                    doc.text(stop.departure || 'N/A', margin + 100, y + 6);
                    y += 8;
                });
                y += 10;

                doc.addPage();
                y = margin;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 100);
                doc.text('Time vs. Speed Graph', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 60, y + 2);
                y += 10;

                if (reportData.speedChartImage) {
                    try {
                        doc.addImage(reportData.speedChartImage, 'PNG', margin, y, contentWidth * 0.8, contentWidth * 0.8 * (600 / 400));
                        y += contentWidth * 0.8 * (600 / 400) + 10;
                    } catch (error) {
                        console.error('Error adding speed chart to PDF:', error);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(255, 0, 0);
                        doc.text('Failed to render speed graph.', margin, y);
                        y += 10;
                    }
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(255, 0, 0);
                    doc.text('No data available for the speed graph.', margin, y);
                    y += 10;
                }
                doc.addPage();
            y = margin;

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            y = checkPageOverflow(y, 10);
            doc.text('Distance Covered During Speed Range', margin, y);
            y += 10;
            
            // First table
            if (reportData.speedRangeSummary?.summary?.length > 0) {
                const speedRangeHeaders = [['Speed Range', 'Distance Covered (KM)', 'Percentage']];
                const speedRangeBody = reportData.speedRangeSummary.summary.map(d => [d.speedRange.replace(/<[^>]*>/g, ''), d.distance, `${d.percentage}%`]);
                
                doc.autoTable({
                    head: speedRangeHeaders,
                    body: speedRangeBody,
                    foot: [['Total Distance Covered', reportData.speedRangeSummary.totalDistance, '100.00%']],
                    startY: y,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 51, 102] },
                    footStyles: { fillColor: [211, 211, 211], textColor: [0, 0, 0], fontStyle: 'bold' }
                });
                y = doc.lastAutoTable.finalY + 10;
            } else {
                doc.text('No data for speed range summary.', margin, y);
                y += 10;
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            y = checkPageOverflow(y, 20); // Extra space before next table
            doc.text('Section-wise Speed Summary', margin, y);
            y += 10;
            
            // Second table
            if (reportData.sectionSpeedSummary?.length > 0) {
                const sectionSpeedHeaders = [['Section', 'Most Frequent Speed (Kmph)', 'Maximum Speed (Kmph)', 'Average Speed (Kmph)']];
                // PDF mein '<strong>' tag hatane ke liye
               const sectionSpeedBody = reportData.sectionSpeedSummary.map(d => [
                d.section.replace(/<[^>]*>/g, ''), // Yeh line HTML tags (jaise <strong>) ko hata deti hai
                d.modeSpeed, 
                d.maxSpeed, 
                d.averageSpeed
               ]);
                doc.autoTable({
                    head: sectionSpeedHeaders,
                    body: sectionSpeedBody,
                    startY: y,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 51, 102] }
                });
                y = doc.lastAutoTable.finalY + 10;
            } else {
                doc.text('No data for average speed summary.', margin, y);
                y+=10;
            }
               doc.addPage();
               y = margin;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Overspeed Details', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 55, y + 2);
                y += 10;

                const colWidthsOverSpeed = { section: 40, timeRange: 110, speedRange: 40 };
                const totalTableWidthOverSpeed = Object.values(colWidthsOverSpeed).reduce((a, b) => a + b, 0);
                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthOverSpeed, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                x = margin;
                doc.text('Section', x + 2, y + 6);
                x += colWidthsOverSpeed.section;
                doc.text('Time Range', x + 2, y + 6);
                x += colWidthsOverSpeed.timeRange;
                doc.text('Speed Range (kmph)', x + colWidthsOverSpeed.speedRange / 2, y + 6, { align: 'center' });
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                if (reportData.overSpeedDetails?.length > 0) {
                    reportData.overSpeedDetails.forEach((detail, index) => {
                        const rowData = [detail.section, detail.timeRange, detail.speedRange];
                        const lines = rowData.map((text, idx) => wrapText(text, Object.values(colWidthsOverSpeed)[idx] - 4, 10));
                        const maxLines = Math.max(...lines.map(l => l.length));
                        rowHeight = maxLines * 8;
                        y = checkPageOverflow(y, rowHeight);
                        doc.setFillColor(index % 2 === 0 ? 220 : 240);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight, 'F');
                        doc.setDrawColor(150);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight);
                        x = margin;
                        lines.forEach((lines, idx) => {
                            const isNumeric = idx === 2;
                            lines.forEach((line, lineIdx) => doc.text(line, isNumeric ? x + Object.values(colWidthsOverSpeed)[idx] / 2 : x + 2, y + 6 + (lineIdx * 6), isNumeric ? { align: 'center' } : null));
                            x += Object.values(colWidthsOverSpeed)[idx];
                        });
                        y += rowHeight;
                    });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    y += 8;
                    y += 2;
                    doc.text('No overspeeding found.', margin, y);
                    y += 10;
                }

                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Suspected Wheel Slip Details', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 55, y + 2);
                y += 10;

                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthOverSpeed, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                x = margin;
                doc.text('Section', x + 2, y + 6);
                x += colWidthsOverSpeed.section;
                doc.text('Time Range', x + 2, y + 6);
                x += colWidthsOverSpeed.timeRange;
                doc.text('Speed Range (kmph)', x + colWidthsOverSpeed.speedRange / 2, y + 6, { align: 'center' });
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                if (reportData.wheelSlipDetails?.length > 0) {
                    reportData.wheelSlipDetails.forEach((detail, index) => {
                        const rowData = [detail.section, detail.timeRange, detail.speedRange];
                        const lines = rowData.map((text, idx) => wrapText(text, Object.values(colWidthsOverSpeed)[idx] - 4, 10));
                        const maxLines = Math.max(...lines.map(l => l.length));
                        rowHeight = maxLines * 8;
                        y = checkPageOverflow(y, rowHeight);
                        doc.setFillColor(index % 2 === 0 ? 220 : 240);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight, 'F');
                        doc.setDrawColor(150);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight);
                        x = margin;
                        lines.forEach((lines, idx) => {
                            const isNumeric = idx === 2;
                            lines.forEach((line, lineIdx) => doc.text(line, isNumeric ? x + Object.values(colWidthsOverSpeed)[idx] / 2 : x + 2, y + 6 + (lineIdx * 6), isNumeric ? { align: 'center' } : null));
                            x += Object.values(colWidthsOverSpeed)[idx];
                        });
                        y += rowHeight;
                    });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    y += 8;
                    y += 2;
                    doc.text('No suspected wheel slips found.', margin, y);
                    y += 10;
                }

                y += 10;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                y = checkPageOverflow(y, 10);
                doc.text('Suspected Wheel Skid Details', margin, y);
                doc.setDrawColor(0, 51, 102);
                doc.line(margin, y + 2, margin + 55, y + 2);
                y += 10;

                doc.setFontSize(10);
                doc.setFillColor(0, 51, 102);
                doc.rect(margin, y, totalTableWidthOverSpeed, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                x = margin;
                doc.text('Section', x + 2, y + 6);
                x += colWidthsOverSpeed.section;
                doc.text('Time Range', x + 2, y + 6);
                x += colWidthsOverSpeed.timeRange;
                doc.text('Speed Range (kmph)', x + colWidthsOverSpeed.speedRange / 2, y + 6, { align: 'center' });
                y += 8;

                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                if (reportData.wheelSkidDetails?.length > 0) {
                    reportData.wheelSkidDetails.forEach((detail, index) => {
                        const rowData = [detail.section, detail.timeRange, detail.speedRange];
                        const lines = rowData.map((text, idx) => wrapText(text, Object.values(colWidthsOverSpeed)[idx] - 4, 10));
                        const maxLines = Math.max(...lines.map(l => l.length));
                        rowHeight = maxLines * 8;
                        y = checkPageOverflow(y, rowHeight);
                        doc.setFillColor(index % 2 === 0 ? 220 : 240);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight, 'F');
                        doc.setDrawColor(150);
                        doc.rect(margin, y, totalTableWidthOverSpeed, rowHeight);
                        x = margin;
                        lines.forEach((lines, idx) => {
                            const isNumeric = idx === 2;
                            lines.forEach((line, lineIdx) => doc.text(line, isNumeric ? x + Object.values(colWidthsOverSpeed)[idx] / 2 : x + 2, y + 6 + (lineIdx * 6), isNumeric ? { align: 'center' } : null));
                            x += Object.values(colWidthsOverSpeed)[idx];
                        });
                        y += rowHeight;
                    });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    y += 8;
                    y += 2;
                    doc.text('No suspected wheel skids found.', margin, y);
                    y += 10;
                }

               doc.addPage();
               y = margin;

                // Upar waala code hatane ke baad, yeh poora block paste karein

doc.setFont('helvetica', 'bold');
doc.setFontSize(12);
doc.setTextColor(0, 0, 0);
y = checkPageOverflow(y, 10);
doc.text('OVERALL OBSERVATION OF CLI', margin, y);
doc.setDrawColor(0, 51, 102);
doc.line(margin, y + 2, margin + 50, y + 2);
y += 10;

const cliRemarks = document.getElementById('cliRemarks').value.trim() || 'No remarks provided.';
const remarkLines = wrapText(cliRemarks, contentWidth - 4, 10);
doc.setFontSize(10);
doc.setFont('helvetica', 'normal');
remarkLines.forEach((line) => {
    y = checkPageOverflow(y, 8);
    doc.text(line, margin + 2, y + 6);
    y += 8;
});
y += 10; // Space after section
// Section: Total Abnormality Found
doc.setFont('helvetica', 'bold');
doc.setFontSize(12);
y = checkPageOverflow(y, 10);
doc.text('Number of Abnormalities Found', margin, y);
doc.setDrawColor(0, 51, 102);
doc.line(margin, y + 2, margin + 50, y + 2);
y += 10;

const totalAbnormalityText = document.getElementById('totalAbnormality').value.trim() || 'NIL';
const totalAbnormalityLines = wrapText(totalAbnormalityText, contentWidth - 4, 10);
doc.setFontSize(10);
doc.setFont('helvetica', 'normal');
totalAbnormalityLines.forEach(line => {
    y = checkPageOverflow(y, 8);
    doc.text(line, margin + 2, y + 6);
    y += 8;
});
y += 10; // Space after section

// Section: Abnormalities Found (from checkboxes)
                doc.setFont('helvetica', 'bold').setFontSize(12).setTextColor(0).text('Detail of Abnormalities', margin, y);
                y += 10;
                // 'cliAbnormalities' की वैल्यू अब googlesheet.js द्वारा सेट की जाएगी
                const cliAbnormalities = document.getElementById('cliAbnormalities').value.trim() || 'NIL';
                doc.setFontSize(10).setFont('helvetica', 'normal');
                doc.splitTextToSize(cliAbnormalities, contentWidth).forEach(line => {
                    y = checkPageOverflow(y, 6);
                    doc.text(line, margin, y);
                    y += 6;
                });
                y += 10;
                
                // Section: Historical Abnormalities Profile (New)
                doc.setFont('helvetica', 'bold').setFontSize(12).text('Total of Last 10 Analysis occuring Abnormalities Till Date', margin, y);
                y = checkPageOverflow(y, 10);
                y += 10;

                const historicalBody = [
                    ['BFT not done', (previousAbnormalityCounts.bft_nd || 0) + (document.getElementById('chk-bft-nd').checked ? 1 : 0)],
                    ['BPT not done', (previousAbnormalityCounts.bpt_nd || 0) + (document.getElementById('chk-bpt-nd').checked ? 1 : 0)],
                    ['BFT not done as per rule', (previousAbnormalityCounts.bft_rule || 0) + (document.getElementById('chk-bft-rule').checked ? 1 : 0)],
                    ['BPT not done as per rule', (previousAbnormalityCounts.bpt_rule || 0) + (document.getElementById('chk-bpt-rule').checked ? 1 : 0)],
                    ['Late Controlling', (previousAbnormalityCounts.late_ctrl || 0) + (document.getElementById('chk-late-ctrl').checked ? 1 : 0)],
                    ['Over speeding', (previousAbnormalityCounts.overspeed || 0) + (document.getElementById('chk-overspeed').checked ? 1 : 0)],
                    ['Others Abnormalities', (previousAbnormalityCounts.others || 0) + (document.getElementById('chk-others').checked ? 1 : 0)]
                ];
                
                doc.autoTable({
                    head: [['Abnormality Type', 'Total Count']],
                    body: historicalBody,
                    startY: y,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 51, 102] }
                });
                y = doc.lastAutoTable.finalY + 10;


// Section: Action Taken
doc.setFont('helvetica', 'bold');
doc.setFontSize(12);
y = checkPageOverflow(y, 10);
doc.text('Action Taken', margin, y);
doc.setDrawColor(0, 51, 102);
doc.line(margin, y + 2, margin + 50, y + 2);
y += 10;

const actionTakenText = document.getElementById('actionTaken').value.trim() || 'NIL';
const actionTakenLines = wrapText(actionTakenText, contentWidth - 4, 10);
doc.setFontSize(10);
doc.setFont('helvetica', 'normal');
actionTakenLines.forEach(line => {
    y = checkPageOverflow(y, 8);
    doc.text(line, margin + 2, y + 6);
    y += 8;
});
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    addFooter();
                }

                doc.save(`SPM_Analysis_${reportData.trainDetails?.find(d => d.label === 'Train Number')?.value || 'Report'}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please check console logs.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }


       // ✅ यह सही और संयुक्त (combined) कोड है
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 1. रिपोर्ट और टैब को रेंडर करें
                renderReport();
                initializeTabs();

                // 2. "Back to Form" बटन का लॉजिक
                document.getElementById('backToForm').addEventListener('click', () => {
                    localStorage.removeItem('spmReportData');
                    window.location.href = 'index.html';
                });

                // 3. डाउनलोड बटन के लिए वैलिडेशन
                const downloadBtn = document.getElementById('downloadReport');
                const cliRemarksTextarea = document.getElementById('cliRemarks');
                downloadBtn.disabled = true;
                downloadBtn.title = 'Please enter at least 15 words in OVERALL OBSERVATION OF CLI SECTION.';

                cliRemarksTextarea.addEventListener('input', () => {
                    const text = cliRemarksTextarea.value.trim();
                    const wordCount = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
                    if (wordCount >= 15) {
                        downloadBtn.disabled = false;
                        downloadBtn.title = 'Click to download the report.';
                    } else {
                        downloadBtn.disabled = true;
                        downloadBtn.title = `Please enter at least ${15 - wordCount} more word(s).`;
                    }
                });

                // 4. असामान्यता (Abnormality) चेकबॉक्स का लॉजिक
                const totalAbnormalityInput = document.getElementById('totalAbnormality');
                document.querySelectorAll('#abnormalities-checkbox-container input[type="checkbox"]').forEach(chk => {
                    chk.addEventListener('change', () => {
                        const textId = chk.dataset.textId;
                        if (textId) {
                            const textField = document.getElementById(textId);
                            textField.style.display = chk.checked ? 'block' : 'none';
                            textField.required = chk.checked;
                            if (!chk.checked) {
                                textField.value = '';
                            }
                        }
                        const count = document.querySelectorAll('#abnormalities-checkbox-container input[type="checkbox"]:checked').length;
                        totalAbnormalityInput.value = count;
                    });
                });

            } catch (error) {
                console.error('Error initializing report:', error);
                document.getElementById('reportContent').innerHTML = '<p class="error-message">Failed to load report. Please return to the form and try again.</p>';
                loadingOverlay.style.display = 'none';
            }
        });
    </script>
     <script src="googlesheet.js"></script>
</body>
</html>