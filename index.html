<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPM Analysis Form</title>
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #ec0c0c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="railway logo.png" alt="Railway Logo" class="logo">
        <h1>SANKET</h1>
        <h3>(SPM Analysis and Navigation KPA Extraction Tool)</h3>
        <h4>(Designed and Developed by Electrical(OP) Bilaspur S.E.C.Railway)</h4>
        <form id="spmForm">
            <div class="form-row">
                <div class="form-section">
                    <h2>LP DETAILS</h2>
                    <div class="box">
                        <div class="form-group">
                            <label for="lpId">LP ID</label>
                            <input type="text" id="lpId" name="lpId" required>
                        </div>
                        <div class="form-group">
                            <label for="lpName">LP Name</label>
                            <input type="text" id="lpName" name="lpName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="lpDesg">LP Designation</label>
                            <input type="text" id="lpDesg" name="lpDesg" readonly>
                        </div>
                        <div class="form-group">
                            <label for="lpGroupCli">LP Group CLI</label>
                            <input type="text" id="lpGroupCli" name="lpGroupCli" readonly>
                        </div>
                        <div class="form-group">
                            <label for="lpCugNumber">LP CUG Number</label>
                            <input type="text" id="lpCugNumber" name="lpCugNumber" readonly>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h2>ALP DETAILS</h2>
                    <div class="box">
                        <div class="form-group">
                            <label for="alpId">ALP ID</label>
                            <input type="text" id="alpId" name="alpId" required>
                        </div>
                        <div class="form-group">
                            <label for="alpName">ALP Name</label>
                            <input type="text" id="alpName" name="alpName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="alpDesg">ALP Designation</label>
                            <input type="text" id="alpDesg" name="alpDesg" readonly>
                        </div>
                        <div class="form-group">
                            <label for="alpGroupCli">ALP Group CLI</label>
                            <input type="text" id="alpGroupCli" name="alpGroupCli" readonly>
                        </div>
                        <div class="form-group">
                            <label for="alpCugNumber">ALP CUG Number</label>
                            <input type="text" id="alpCugNumber" name="alpCugNumber" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-section">
                    <h2>TRAIN DETAILS</h2>
                    <div class="box">
                        <div class="form-group">
                            <label for="locoNumber">Loco Number</label>
                            <input type="text" id="locoNumber" name="locoNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="trainNumber">Train Number</label>
                            <input type="text" id="trainNumber" name="trainNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="rakeType">Type of Rake</label>
                            <select id="rakeType" name="rakeType" required>
                                <option value="" disabled selected>Select Rake Type</option>
                                <option value="GOODS">GOODS</option>
                                <option value="COACHING">COACHING</option>
                                <option value="MEMU">MEMU</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxPermissibleSpeed">Maximum Permissible Speed (kmph)</label>
                            <select id="maxPermissibleSpeed" name="maxPermissibleSpeed" required>
                                <option value="" disabled selected>Select Speed</option>
                                <option value="40">40 kmph</option>
                                <option value="45">45 kmph</option>
                                <option value="50">50 kmph</option>
                                <option value="55">55 kmph</option>
                                <option value="60">60 kmph</option>
                                <option value="65">65 kmph</option>
                                <option value="70">70 kmph</option>
                                <option value="75">75 kmph</option>
                                <option value="80">80 kmph</option>
                                <option value="85">85 kmph</option>
                                <option value="90">90 kmph</option>
                                <option value="95">95 kmph</option>
                                <option value="100">100 kmph</option>
                                <option value="105">105 kmph</option>
                                <option value="110">110 kmph</option>
                                <option value="115">115 kmph</option>
                                <option value="120">120 kmph</option>
                                <option value="125">125 kmph</option>
                                <option value="130">130 kmph</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h2>SECTION DETAILS</h2>
                    <div class="box">
                        <div class="form-group">
                            <label for="section">Section</label>
                            <select id="section" name="section" required>
                                <option value="" disabled selected>Select Section</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fromSection">From Section</label>
                            <select id="fromSection" name="fromSection" required>
                                <option value="" disabled selected>Select From Station</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="toSection">To Section</label>
                            <select id="toSection" name="toSection" required>
                                <option value="" disabled selected>Select To Station</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h2>ANALYSIS DETAILS</h2>
                <div class="box">
                    <div class="form-group">
                        <label for="spmType">Type of SPM</label>
                        <select id="spmType" name="spmType" required>
                            <option value="" disabled selected>Select SPM Type</option>
                            <option value="Laxven">Laxven</option>
                            <option value="Medha">Medha</option>
                            <option value="Telpro">Telpro</option>
                            <option value="MR">MR</option>
                            <option value="VEL">VEL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fromDateTime">From Date and Time</label>
                        <input type="datetime-local" id="fromDateTime" name="fromDateTime" required>
                    </div>
                    <div class="form-group">
                        <label for="toDateTime">To Date and Time</label>
                        <input type="datetime-local" id="toDateTime" name="toDateTime" required>
                    </div>
                    <div class="form-group">
                        <label for="cugFile">Upload CUG.csv File</label>
                        <input type="file" id="cugFile" name="cugFile" accept=".csv">
                    </div>
                    <div class="form-group">
                        <label for="spmFile">Upload SPM File</label>
                        <input type="file" id="spmFile" name="spmFile" accept=".xlsx,.xls,.txt,.pdf" required>
                    </div>
                </div>
            </div>
            <button type="submit">ANALYZE THE SPM DATA</button>
        </form>
    </div>
    <canvas id="speedChart" style="display: none;"></canvas>
    <canvas id="stopChart" style="display: none;"></canvas>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Global function to toggle loading overlay
        window.toggleLoadingOverlay = function(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        function loadScript(src, callback) {
            const existingScript = document.querySelector('script[data-spm-script]');
            if (existingScript) existingScript.remove();
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.dataset.spmScript = true;
            script.onload = callback;
            script.onerror = () => {
                alert(`Failed to load script: ${src}. Please ensure the script exists and try again.`);
                window.toggleLoadingOverlay(false);
            };
            document.body.appendChild(script);
        }

        let crewData = [];
        let stationSignalData = [];
        // cugData will be populated from the uploaded file

        const fetchCSV = async (filePath) => {
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`Failed to fetch ${filePath}: ${response.statusText}`);
                const text = await response.text();
                return new Promise((resolve) => {
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        transform: (value, field) => value.trim(),
                        complete: (result) => resolve(result.data),
                    });
                });
            } catch (error) {
                console.error(`Error loading ${filePath}:`, error);
                throw error;
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                crewData = await fetchCSV('CREW.csv');
                console.log('Loaded CREW Data:', crewData);
                stationSignalData = await fetchCSV('Station_Signal_Interdistant.csv');
                console.log('Loaded Station Signal Data:', stationSignalData);

                window.crewData = crewData;
                window.stationSignalData = stationSignalData;

                const sectionSelect = document.getElementById('section');
                const uniqueSections = [...new Set(stationSignalData.map(row => row['SECTION']))];
                uniqueSections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = section;
                    sectionSelect.appendChild(option);
                });

                const fromSectionSelect = document.getElementById('fromSection');
                const toSectionSelect = document.getElementById('toSection');

                sectionSelect.addEventListener('change', (e) => {
                    const selectedSection = e.target.value;
                    fromSectionSelect.innerHTML = '<option value="" disabled selected>Select From Station</option>';
                    toSectionSelect.innerHTML = '<option value="" disabled selected>Select To Station</option>';
                    if (selectedSection) {
                        const stations = [...new Set(stationSignalData
                            .filter(row => row['SECTION'] === selectedSection)
                            .map(row => row['STATION']))];
                        stations.forEach(station => {
                            const option = document.createElement('option');
                            option.value = station;
                            option.textContent = station;
                            fromSectionSelect.appendChild(option);
                            toSectionSelect.appendChild(option.cloneNode(true));
                        });
                    }
                });

                document.getElementById('lpId').addEventListener('input', (e) => {
                    // Input ko format karne ka code
                    const input = e.target;
                    let value = input.value.toUpperCase();
                    input.value = value.replace(/[^A-Z0-9]/g, '');
                    const lpId = e.target.value.trim();
                    const lpRecord = crewData.find(record => record['CREWID'] === lpId);
                    if (lpRecord) {
                        console.log(`LP ID ${lpId} matched with details:`, lpRecord);
                        document.getElementById('lpName').value = lpRecord['CREW NAME'] || '';
                        document.getElementById('lpDesg').value = lpRecord['DESG'] || '';
                        document.getElementById('lpGroupCli').value = lpRecord['CLI NAME'] || '';
                        document.getElementById('lpCugNumber').value = lpRecord['CUG NUMBER'] || '';
                    } else {
                        document.getElementById('lpName').value = '';
                        document.getElementById('lpDesg').value = '';
                        document.getElementById('lpGroupCli').value = '';
                        document.getElementById('lpCugNumber').value = '';
                        console.log(`No record found for LP ID: ${lpId}`);
                    }
                });

                document.getElementById('alpId').addEventListener('input', (e) => {
                    // Input ko format karne ka code
                    const input = e.target;
                    let value = input.value.toUpperCase();
                    input.value = value.replace(/[^A-Z0-9]/g, '');
                    const alpId = e.target.value.trim();
                    const alpRecord = crewData.find(record => record['CREWID'] === alpId);
                    if (alpRecord) {
                        console.log(`ALP ID ${alpId} matched with details:`, alpRecord);
                        document.getElementById('alpName').value = alpRecord['CREW NAME'] || '';
                        document.getElementById('alpDesg').value = alpRecord['DESG'] || '';
                        document.getElementById('alpGroupCli').value = alpRecord['CLI NAME'] || '';
                        document.getElementById('alpCugNumber').value = alpRecord['CUG NUMBER'] || '';
                    } else {
                        document.getElementById('alpName').value = '';
                        document.getElementById('alpDesg').value = '';
                        document.getElementById('alpGroupCli').value = '';
                        document.getElementById('alpCugNumber').value = '';
                        console.log(`No record found for ALP ID: ${alpId}`);
                    }
                });

                const spmTypeSelect = document.getElementById('spmType');
                let currentScript = null;

                spmTypeSelect.addEventListener('change', (e) => {
                    const spmType = e.target.value;
                    const fileInput = document.getElementById('spmFile');
                    if (spmType === 'Medha') {
                        fileInput.accept = '.txt';
                    } else if (spmType === 'MR' || spmType === 'VEL') {
                        fileInput.accept = '.pdf';
                    } else {
                        fileInput.accept = '.xlsx, .xls';
                    }
                    if (spmType) {
                        const scriptFile = `${spmType}.js`;
                        loadScript(scriptFile, () => {
                            console.log(`${scriptFile} loaded successfully`);
                            currentScript = scriptFile;
                        });
                    }
                });

                const parseCugFile = (file) => {
                    return new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            transform: (value) => value.trim(),
                            complete: (result) => {
                                console.log('Raw CUG Data from upload:', result.data);
                                const processedData = result.data.map(call => {
                                    const startDateTimeStr = call['Start Date & Time']?.trim();
                                    const endDateTimeStr = call['End Date & Time']?.trim();
                                    const dateTimeRegex = /^(?:(\d{2})[-\/](\d{2})[-\/](\d{4})|(\d{4})[-\/](\d{2})[-\/](\d{2}))\s(\d{2}):(\d{2})(?::(\d{2}))?$/;
                                    const startMatch = startDateTimeStr?.match(dateTimeRegex);
                                    const endMatch = endDateTimeStr?.match(dateTimeRegex);
                                    if (startMatch && endMatch) {
                                        let startDateTime, endDateTime;
                                        const startSeconds = startMatch[9] || '00';
                                        const endSeconds = endMatch[9] || '00';
                                        if (startMatch[1]) { // DD-MM-YYYY
                                            startDateTime = new Date(`${startMatch[3]}-${startMatch[2]}-${startMatch[1]}T${startMatch[7]}:${startMatch[8]}:${startSeconds}`);
                                            endDateTime = new Date(`${endMatch[3]}-${endMatch[2]}-${endMatch[1]}T${endMatch[7]}:${endMatch[8]}:${endSeconds}`);
                                        } else { // YYYY-MM-DD
                                            startDateTime = new Date(`${startMatch[4]}-${startMatch[5]}-${startMatch[6]}T${startMatch[7]}:${startMatch[8]}:${startSeconds}`);
                                            endDateTime = new Date(`${endMatch[4]}-${endMatch[5]}-${endMatch[6]}T${endMatch[7]}:${endMatch[8]}:${endSeconds}`);
                                        }
                                        return {
                                            ...call,
                                            startDateTime,
                                            endDateTime,
                                            duration: parseInt(call['Duration in Sec']) || 0,
                                            'CUG MOBILE NO': call['CUG MOBILE NO']?.trim()
                                        };
                                    } else {
                                        console.warn('Invalid date format in CUG.csv:', { startDateTimeStr, endDateTimeStr });
                                        return null;
                                    }
                                }).filter(call => call && !isNaN(call.startDateTime.getTime()) && !isNaN(call.endDateTime.getTime()) && !isNaN(call.duration));
                                
                                console.log('Processed CUG Data from upload:', processedData);
                                resolve(processedData);
                            },
                            error: (error) => {
                                console.error('Error parsing CUG.csv:', error);
                                reject(error);
                            }
                        });
                    });
                };

                document.getElementById('spmForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    document.getElementById('loadingOverlay').style.display = 'flex';

                    const spmType = document.getElementById('spmType').value;
                    const spmFile = document.getElementById('spmFile').files[0];
                    const cugFile = document.getElementById('cugFile').files[0];
                    if (!spmType) {
                        alert('Please select an SPM Type.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    }
                    if (!spmFile) {
                        alert('Please upload an SPM file.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    }
                    const fileExt = spmFile.name.split('.').pop().toLowerCase();
                    if (spmType === 'Medha' && fileExt !== 'txt') {
                        alert('Please upload a .txt file for Medha SPM.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    } else if ((spmType === 'MR' || spmType === 'VEL') && fileExt !== 'pdf') {
                        alert('Please upload a .pdf file for MR or VEL SPM.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    } else if (['Laxven', 'Telpro'].includes(spmType) && !['xlsx', 'xls'].includes(fileExt)) {
                        alert('Please upload an Excel file (.xlsx or .xls) for Laxven or Telpro SPM.');
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    }
                    if (!currentScript) {
                        alert(`No script loaded for SPM Type: ${spmType}. Please select SPM Type first.`);
                        document.getElementById('loadingOverlay').style.display = 'none';
                        return;
                    }
                });

            } catch (error) {
                console.error('Error loading initial CSV files:', error);
                alert('Failed to load CREW.csv or Station_Signal_Interdistant.csv. Ensure the files are available and correctly formatted.');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    </script>
</body>
</html>
